#include <stdio.h>
#include <stdbool.h>
#include "hal_crc.h"
#include "osal_log.h"

/* Test data from original S32K312 code */
#define CRC_DATA_SIZE (547U)
#define RESULT_CRC_16BIT_CCITT_FALSE (0xFBF1U)
#define RESULT_CRC_32BIT_ETHERNET (0x0E551D7CU)

static const uint8_t CRC_data[] = {
    0x94U, 0x21U, 0xFFU, 0xE0U, 0x7CU, 0x08U, 0x02U, 0xA6U, 0xBFU, 0xC1U, 0x00U, 0x18U, 0x90U,
    0x01U, 0x00U, 0x24U, 0x3BU, 0xE0U, 0x00U, 0x00U, 0x93U, 0xE1U, 0x00U, 0x0CU, 0x88U, 0x03U,
    0x00U, 0x34U, 0x2CU, 0x00U, 0x00U, 0x00U, 0x41U, 0x82U, 0x00U, 0x4CU, 0x80U, 0x03U, 0x00U,
    0x00U, 0x90U, 0x01U, 0x00U, 0x08U, 0x80U, 0x03U, 0x00U, 0x38U, 0x54U, 0x00U, 0x00U, 0x01U,
    0x41U, 0x82U, 0x00U, 0x44U, 0x81U, 0x63U, 0x00U, 0x00U, 0x54U, 0x80U, 0x06U, 0x3EU, 0x2CU,
    0x00U, 0x00U, 0x01U, 0x80U, 0x0BU, 0x00U, 0x0CU, 0x54U, 0x00U, 0x00U, 0x3AU, 0x90U, 0x0BU,
    0x00U, 0x0CU, 0x40U, 0x82U, 0x00U, 0x28U, 0x81U, 0x63U, 0x00U, 0x00U, 0x80U, 0x0BU, 0x00U,
    0x0CU, 0x54U, 0x00U, 0x07U, 0xBFU, 0x41U, 0x82U, 0x01U, 0x84U, 0x3FU, 0xE0U, 0x00U, 0x20U,
    0x48U, 0x00U, 0x01U, 0x7CU, 0x81U, 0x63U, 0x00U, 0x00U, 0x38U, 0x0BU, 0x00U, 0x04U, 0x90U,
    0x01U, 0x00U, 0x08U, 0x81U, 0x61U, 0x00U, 0x08U, 0x80U, 0x0BU, 0x00U, 0x00U, 0x54U, 0x0BU,
    0x07U, 0xBDU, 0x41U, 0x82U, 0x00U, 0x14U, 0x54U, 0x0BU, 0xEFU, 0xFEU, 0x38U, 0x0BU, 0x00U,
    0x02U, 0x90U, 0x01U, 0x00U, 0x0CU, 0x48U, 0x00U, 0x00U, 0x14U, 0x54U, 0x00U, 0x07U, 0x39U,
    0x41U, 0x82U, 0x00U, 0x0CU, 0x38U, 0x00U, 0x00U, 0x01U, 0x90U, 0x01U, 0x00U, 0x0CU, 0x80U,
    0x01U, 0x00U, 0x0CU, 0x54U, 0x00U, 0x07U, 0xFFU, 0x41U, 0x82U, 0x00U, 0x48U, 0x81U, 0x61U,
    0x00U, 0x08U, 0x80U, 0x0BU, 0x00U, 0x00U, 0x54U, 0x00U, 0x05U, 0x6BU, 0x41U, 0x82U, 0xFFU,
    0xF4U, 0x81U, 0x61U, 0x00U, 0x08U, 0x3CU, 0x00U, 0xFFU, 0xFFU, 0x60U, 0x00U, 0x1FU, 0xF7U,
    0x81U, 0x81U, 0x00U, 0x08U, 0x81U, 0x8CU, 0x00U, 0x00U, 0x61U, 0x8CU, 0x00U, 0x01U, 0x7DU,
    0x8CU, 0x00U, 0x38U, 0x91U, 0x8BU, 0x00U, 0x00U, 0x81U, 0x81U, 0x00U, 0x08U, 0x81U, 0x61U,
    0x00U, 0x08U, 0x81U, 0x6BU, 0x00U, 0x00U, 0x7CU, 0x00U, 0x58U, 0x38U, 0x90U, 0x0CU, 0x00U,
    0x00U, 0x80U, 0x01U, 0x00U, 0x0CU, 0x54U, 0x00U, 0x07U, 0xBDU, 0x41U, 0x82U, 0x00U, 0x80U,
    0x81U, 0x61U, 0x00U, 0x08U, 0x3CU, 0x00U, 0xFFU, 0xFFU, 0x60U, 0x00U, 0x1FU, 0xFEU, 0x81U,
    0x81U, 0x00U, 0x08U, 0x81U, 0x8CU, 0x00U, 0x00U, 0x7CU, 0x00U, 0x60U, 0x38U, 0x90U, 0x0BU,
    0x00U, 0x00U, 0x81U, 0x61U, 0x00U, 0x08U, 0x80U, 0x0BU, 0x00U, 0x00U, 0x54U, 0x00U, 0x05U,
    0x6BU, 0x41U, 0x82U, 0xFFU, 0xF4U, 0x81U, 0x61U, 0x00U, 0x08U, 0x3CU, 0x00U, 0xFFU, 0xFFU,
    0x60U, 0x00U, 0x1FU, 0xEFU, 0x3FU, 0xC0U, 0xFFU, 0xFFU, 0x63U, 0xDEU, 0x1FU, 0xFDU, 0x81U,
    0x81U, 0x00U, 0x08U, 0x81U, 0x8CU, 0x00U, 0x00U, 0x7CU, 0x00U, 0x60U, 0x38U, 0x90U, 0x0BU,
    0x00U, 0x00U, 0x81U, 0x81U, 0x00U, 0x08U, 0x81U, 0x61U, 0x00U, 0x08U, 0x80U, 0x0BU, 0x00U,
    0x00U, 0x60U, 0x00U, 0x00U, 0x01U, 0x7CU, 0x00U, 0xF0U, 0x38U, 0x90U, 0x0CU, 0x00U, 0x00U,
    0x81U, 0x81U, 0x00U, 0x08U, 0x81U, 0x61U, 0x00U, 0x08U, 0x80U, 0x0BU, 0x00U, 0x00U, 0x7CU,
    0x00U, 0xF0U, 0x38U, 0x90U, 0x0CU, 0x00U, 0x00U, 0x81U, 0x61U, 0x00U, 0x08U, 0x3CU, 0x00U,
    0xFFU, 0xFFU, 0x60U, 0x00U, 0x1FU, 0xFEU, 0x81U, 0x81U, 0x00U, 0x08U, 0x81U, 0x8CU, 0x00U,
    0x00U, 0x7CU, 0x00U, 0x60U, 0x38U, 0x90U, 0x0BU, 0x00U, 0x00U, 0x81U, 0x61U, 0x00U, 0x08U,
    0x80U, 0x0BU, 0x00U, 0x00U, 0x54U, 0x00U, 0x05U, 0x6BU, 0x41U, 0x82U, 0xFFU, 0xF4U, 0x81U,
    0x61U, 0x00U, 0x08U, 0x3FU, 0xC0U, 0xFFU, 0xFFU, 0x63U, 0xDEU, 0x1FU, 0xEFU, 0x3CU, 0x00U,
    0xFFU, 0xFFU, 0x60U, 0x00U, 0x1FU, 0xFBU, 0x81U, 0x81U, 0x00U, 0x08U, 0x81U, 0x8CU, 0x00U,
    0x00U, 0x7DU, 0x8CU, 0xF0U, 0x38U, 0x91U, 0x8BU, 0x00U, 0x00U, 0x81U, 0x81U, 0x00U, 0x08U,
    0x81U, 0x61U, 0x00U, 0x08U, 0x81U, 0x6BU, 0x00U, 0x00U, 0x7CU, 0x00U, 0x58U, 0x38U, 0x90U,
    0x0CU, 0x00U, 0x00U, 0x88U, 0x03U, 0x00U, 0x3CU, 0x2CU, 0x00U, 0x00U, 0x00U, 0x41U, 0x82U,
    0x00U, 0x14U, 0x7FU, 0xE3U, 0xFBU, 0x78U, 0x60U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U,
    0x00U, 0x60U, 0x00U, 0x00U, 0x00U, 0x7FU, 0xE3U, 0xFBU, 0x78U, 0x80U, 0x01U, 0x00U, 0x24U,
    0xBBU, 0xC1U, 0x00U, 0x18U, 0x7CU, 0x08U, 0x03U, 0xA6U, 0x38U, 0x21U, 0x00U, 0x20U, 0x4EU,
    0x80U, 0x00U, 0x20U, 0x4DU, 0x50U, 0x43U, 0x35U, 0x35U, 0x46U, 0x41U, 0x31U, 0x31U, 0x30U,
    0x00U
};

/* CRC32 test data */
static const uint8_t test_data1[] = {
    '1', '2', '3', '4', '5', '6', '7', '8', '9'
};
static const uint32_t test_data1_crc32 = 0xCBF43926U; /* CRC32-Ethernet for "123456789" */

static const uint8_t test_data2[] = {
    0x48, 0x65, 0x6C, 0x6C, 0x6F /* "Hello" */
};
static const uint32_t test_data2_crc32 = 0xF7D18982U;

int test_crc(void) {
    bool status = true;
    uint16_t crc16_result;
    uint32_t crc32_result;
    char log_buffer[64];

    /* Initialize CRC module */
    osal_log_info("Initializing CRC module\r\n");
    hal_crc_init();

    /* Test CRC32 with test_data1 */
    osal_log_info("Testing CRC32 with test_data1 (123456789)\r\n");
    crc32_result = hal_crc32_compute(test_data1, sizeof(test_data1), 0);
    snprintf(log_buffer, sizeof(log_buffer), "CRC32 test 1: calculated=0x%08X, expected=0x%08X\r\n",
             crc32_result, test_data1_crc32);
    osal_log_info(log_buffer);
    if (crc32_result == test_data1_crc32) {
        osal_log_info("CRC32 test 1 passed\r\n");
    } else {
        osal_log_info("CRC32 test 1 failed\r\n");
        status = false;
    }

    /* Test CRC32 with test_data2 */
    osal_log_info("Testing CRC32 with test_data2 (Hello)\r\n");
    crc32_result = hal_crc32_compute(test_data2, sizeof(test_data2), 0xFFFFFFFFU);
    snprintf(log_buffer, sizeof(log_buffer), "CRC32 test 2: calculated=0x%08X, expected=0x%08X\r\n",
             crc32_result, test_data2_crc32);
    osal_log_info(log_buffer);
    if (crc32_result == test_data2_crc32) {
        osal_log_info("CRC32 test 2 passed\r\n");
    } else {
        osal_log_info("CRC32 test 2 failed\r\n");
        status = false;
    }

    /* Test CRC32 with CRC_data */
    osal_log_info("Testing CRC32 with CRC_data\r\n");
    crc32_result = hal_crc32_compute(CRC_data, CRC_DATA_SIZE, 0xFFFFFFFFU);
    snprintf(log_buffer, sizeof(log_buffer), "CRC32 test 3: calculated=0x%08X, expected=0x%08X\r\n",
             crc32_result, RESULT_CRC_32BIT_ETHERNET);
    osal_log_info(log_buffer);
    if (crc32_result == RESULT_CRC_32BIT_ETHERNET) {
        osal_log_info("CRC32 test 3 passed\r\n");
    } else {
        osal_log_info("CRC32 test 3 failed\r\n");
        status = false;
    }

    /* Test CRC16 with CRC_data */
    osal_log_info("Testing CRC16 with CRC_data\r\n");
    crc16_result = hal_crc16_compute(CRC_data, CRC_DATA_SIZE, 0xFFFFU);
    snprintf(log_buffer, sizeof(log_buffer), "CRC16 test 4: calculated=0x%04X, expected=0x%04X\r\n",
             crc16_result, RESULT_CRC_16BIT_CCITT_FALSE);
    osal_log_info(log_buffer);
    if (crc16_result == RESULT_CRC_16BIT_CCITT_FALSE) {
        osal_log_info("CRC16 test 4 passed\r\n");
    } else {
        osal_log_info("CRC16 test 4 failed\r\n");
        status = false;
    }

    /* Deinitialize CRC module */
    osal_log_info("Deinitializing CRC module\r\n");
    hal_crc_deinit();

    /* Log final result */
    if (status) {
        osal_log_info("All CRC tests passed\r\n");
    } else {
        osal_log_info("Some CRC tests failed\r\n");
    }

    return status ? 0 : 1;
}
